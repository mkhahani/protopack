/**
 * Protopack is set of DHTML UI Components based on Prototype JS framework
 *
 * @author      Mohsen Khahani <mkhahani@gmail.com>
 * @copyright   2011-2013 Mohsen Khahani
 * @license     MIT
 * @version     1.0dev
 * @url         http://mohsenkhahani.ir/protopack
 */
if(typeof Prototype==="undefined"||!Prototype.Version.match("1.7")){throw ("Protopack requires Prototype JavaScript framework 1.7.0+")}var Protopack=Protopack||{version:"1.0dev",extendEvents:function(a){Object.extend(a,{initObserve:function(b){this.observers=this.observers||{};this.observers[b]=this.observers[b]||[]},observe:function(c,b){this.initObserve(c);if(!this.observers[c].include(b)){this.observers[c].push(b)}},fire:function(d){this.initObserve(d);if(this.observers[d]!==undefined){for(var c=0;c<this.observers[d].length;c++){var b=$A(arguments).slice(1);this.observers[d][c].apply(this,b)}}}})}};if(Object.isUndefined(Prototype.Browser.IE6)){Prototype.Browser.IE6=(navigator.appName.indexOf("Microsoft Internet Explorer")!=-1&&navigator.appVersion.indexOf("MSIE 6.0")!=-1&&!window.XMLHttpRequest)}Element.addMethods({getInnerText:function(a){a=$(a);return(a.innerText&&!window.opera)?a.innerText:a.innerHTML.stripScripts().unescapeHTML().replace(/[\n\r\s]+/g," ")}});function addCommas(f,g){var d=/(\d+)(\d{3})/,a,c,b,e;f+="";a=f.split(".");c=a[0];b=a.length>1?"."+a[1]:"";while(d.test(c)){c=c.replace(d,"$1,$2")}e=c+b;if(!e.blank()&&g!==undefined){e=g+e}return e}Protopack.Input=Class.create({options:{className:"pinput",readonly:true,buttonStyle:"smart",dropdownStyle:"auto"},initialize:function(b,a){this.options=Object.clone(this.options);Object.extend(this.options,a||{});this.className=this.options.className;this.buttonStyle=this.options.buttonStyle;this.dropdownStyle=this.options.dropdownStyle;if(b){this.target=$(b);this.xhtml=this.construct()}},construct:function(){var a=new Element("div",{"class":this.className});this.entry=this.buildEntry();a.insert(this.entry);if(this.buttonStyle!=="disabled"){this.button=this.buildButton(a);a.insert(this.button)}if(this.dropdownStyle!=="disabled"){this.dropdown=this.buildDropdown(a)}if(this.target){this.target.insert(a)}return a},buildEntry:function(){var a=(this.entry)?(this.entry):new Element("input",{type:"text"});if(this.options.readonly){a.writeAttribute({readonly:true})}if(this.buttonStyle==="smart"){a.observe("mousedown",function(){this.button.hide()}.bind(this))}a.observe("mousedown",this.click.bind(this));return a},buildButton:function(b){var a=new Element("button");if(this.buttonStyle==="smart"){a.hide();b.observe("mouseover",function(){a.show()}.bind(this));b.observe("mouseout",function(){a.hide()}.bind(this))}a.observe("click",this.buttonClick.bind(this));return a},buildDropdown:function(b){var a={className:this.className+"-dropdown",modal:false,draggable:false,showHeader:false,closeButton:false,autoClose:true,autoCenter:false},c=new Protopack.Window(a,b);c.excludedElements.push(this.entry);return c},click:function(a){if(this.dropdownStyle==="auto"&&Event.isLeftClick(a)){this.dropdown.toggle()}},buttonClick:function(a){if(this.dropdownStyle==="auto"){this.dropdown.toggle()}},get:function(){return this.xhtml},grab:function(a){this.entry=$(a);this.xhtml.update();this.xhtml=this.construct()},render:function(){if(this.dropdown.window.getWidth()<this.entry.getWidth()){this.dropdown.window.style.width=this.entry.getWidth()+"px"}this.dropdown.window.style.top=this.entry.getHeight()+1+"px"},setId:function(a){this.entry.id=a},setName:function(a){this.entry.name=a},setText:function(a){this.entry.value=a},openUp:function(){this.dropdown.open()}});Protopack.Tree=Class.create({options:{className:"ptree",interactive:true,multiSelect:false,rootId:0},initialize:function(b,a){this.options=Object.clone(this.options);Object.extend(this.options,a||{});this.multiSelect=this.options.multiSelect;this.rootId=this.options.rootId;this.selected=(this.multiSelect)?[]:null;this.nodeById={};this.xhtml=this.construct(b);Protopack.extendEvents(this)},construct:function(b){var a=new Element("div",{"class":this.options.className});if(b){$(b).update(a)}a.observe("node:click",this.click.bind(this));a.observe("node:mouseover",this.mouseOver.bind(this));a.observe("node:mouseout",this.mouseOut.bind(this));a.observe("node:toggle",this.toggle.bind(this));a.observe("node:create",this.nodeCreate.bind(this));return a},loadData:function(d){var a,b=function(g,j){var e=d.partition(function(i){return i[1]==g}),f;d=e[1];for(f=0;f<e[0].length;f++){var k=e[0][f],h=j.addNode(k[0],k[1],k[2],k[3]||null);if(d.length>0){b(k[0],h)}}};this.dataObj=new Protopack.Tree.Data(this.rootId,-1,"root",null);b(this.rootId,this.dataObj);a=this.createChilds(this.dataObj.childs);this.xhtml.update(a);try{a.down("li").addClassName("first")}catch(c){}},createNode:function(c,a){var b=null;this.fire("tree:nodecreate",c,b);nodeObj=new Protopack.Tree.Node(c,b,a);nodeObj.element.addClassName("node");if(this.multiSelect){if(nodeObj.data.extra.checked){this.selected.push(nodeObj.data.id)}}return nodeObj},createChilds:function(a){var c=new Element("ul"),b={multiSelect:this.multiSelect,interactive:this.options.interactive},d;a.each(function(f,e){d=this.createNode(f,b);if(f.childs.length>0){d.expander.addClassName("close")}if(e===a.length-1){d.outer.addClassName("last")}c.insert(d.outer);this.nodeById[f.id]=d}.bind(this));return c},getChilds:function(b){var a=b.element.next("ul");if(a===undefined){a=this.createChilds(b.data.childs);b.outer.insert(a)}return a},selectNode:function(a){if(this.nodeById[a]===undefined){return}if(this.multiSelect){if(this.selected.indexOf(a)===-1){this.selected.push(a)}this.nodeById[a].data.extra.checked=true;this.nodeById[a].element.down("input").checked=true}else{this.nodeById[a].element.addClassName("selected");this.selected=a}},deselectNode:function(a){if(this.nodeById[a]===undefined){return}if(this.multiSelect){this.nodeById[a].data.extra.checked=false;this.nodeById[a].element.down("input").checked=false;this.selected.splice(this.selected.indexOf(a),1)}else{this.nodeById[a].element.removeClassName("selected");this.selected=null}}});Protopack.Tree.Data=Class.create({initialize:function(d,b,c,a){this.id=d;this.pid=b;this.text=c;this.extra=a||{};this.childs=[]},getNode:function(b){if(this.id==b){return this}var a=false;this.childs.each(function(c){if(c.id==b){a=c;throw $break}});if(a===false){this.childs.each(function(c){a=c.getNode(b);if(a){throw $break}})}return a},addNode:function(f,b,e,a){var c=this.getNode(b),d=new Protopack.Tree.Data(f,b,e,a);c.childs.push(d);return d},deleteNode:function(c){var a=this.getNode(pid),b=new Protopack.Tree.Data(c,pid,text,extra);a.childs.push(b);return b},getChildren:function(a){var b=this.childs.clone();if(a){this.childs.each(function(d){var c=d.getChildren(true);b=b.concat(c)})}return b}});Protopack.Tree.Node=Class.create({initialize:function(c,b,a){this.data=c;this.inner=b;this.options={};Object.extend(this.options,a||{});this.outer=this.construct()},construct:function(){var b=new Element("li"),c=new Element("span"),a=new Element("div");if(!this.inner){this.inner=this.buildNode()}a.insert(this.inner);a.observe("click",this.click.bind(this));a.observe("mouseover",this.mouseOver.bind(this));a.observe("mouseout",this.mouseOut.bind(this));this.element=a;c.observe("click",this.toggle.bind(this)),b.insert(c);this.expander=c;b.insert(a);return b},buildNode:function(){var a;if(this.options.multiSelect){var b=new Element("input",{type:"checkbox",value:this.data.id});a=new Element("div");if(typeof this.data.checked!="undefined"){b.writeAttribute({checked:this.data.checked})}else{this.data.checked=false}a.insert(b);a.insert(new Element("label").update(this.data.text))}else{a=new Element("a").update(this.data.text)}return a},click:function(){this.element.fire("node:click",this)},mouseOver:function(){this.element.fire("node:mouseover",this)},mouseOut:function(){this.element.fire("node:mouseout",this)},toggle:function(){this.element.fire("node:toggle",this)}});Protopack.Tree.addMethods({click:function(a){var b=a.memo.data.id;if(this.multiSelect){if(a.memo.data.extra.checked){this.deselectNode(b)}else{this.selectNode(b)}}else{this.deselectNode(this.selected);this.selectNode(b)}this.fire("tree:click",a.memo)},mouseOver:function(a){a.memo.element.addClassName("hover");this.fire("tree:mouseover",a.memo)},mouseOut:function(a){a.memo.element.removeClassName("hover");this.fire("tree:mouseout",a.memo)},toggle:function(a){var b=a.memo.data.id;if(a.memo.expander.className==="close"){this.expand(b)}else{this.collapse(b)}this.fire("tree:toggle",a.memo)},nodeCreate:function(a){this.fire("tree:nodecreate",a.memo)}});Protopack.Tree.addMethods({getNode:function(a){return this.nodeById[a]},setId:function(a){this.xhtml.id=a},setClassName:function(a){this.xhtml.className=a},setCaption:function(a){if(this.caption){this.caption.update(a)}else{this.caption=new Element("div",{"class":"caption"}).update(a);this.xhtml.insert({top:this.caption})}return this.caption},expand:function(c,a){if(!this.nodeById[c]){return}var b=this.nodeById[c];this.getChilds(b).show();if(b.data.childs.length>0){b.expander.className="open"}if(a){b.data.childs.each(function(d){this.expand(d.id,true)},this)}},collapse:function(c,a){if(!this.nodeById[c]){return}var b=this.nodeById[c];this.getChilds(b).hide();if(b.data.childs.length>0){b.expander.className="close"}if(a){b.data.childs.each(function(d){this.collapse(d.id,true)},this)}},expandAll:function(){this.dataObj.childs.each(function(a){this.expand(a.id,true)},this)},collapseAll:function(){this.dataObj.childs.each(function(a){this.collapse(a.id,true)},this)},select:function(a){if(this.multiSelect){a=Object.isArray(a)?a.uniq():[a];a.each(function(b){this.selectNode(b)},this)}else{this.selectNode(a)}},selectAll:function(){if(this.multiSelect){this.select(Object.keys(this.nodeById))}},clear:function(){if(this.multiSelect){var b=this.selected.clone();for(var a=0;a<b.length;a++){this.deselectNode(b[a])}this.selected.clear()}else{this.deselectNode(this.selected)}},insertNode:function(d,h,j,f){var e,a,b,c;if(h=="0"){b=this.dataObj;c=this.xhtml.down("ul")}else{var i=this.nodeById[h];if(!i){return}b=i.data;c=this.getChilds(i);i.expander.className="open"}e=b.addNode(d,h,j,f);a=this.createNode(e);c.insert(a.outer);a.outer.addClassName("last");this.nodeById[d]=a;try{a.outer.previous("li").removeClassName("last")}catch(g){}return a},deleteNode:function(d){var a=this.nodeById[d],b,h,g;if(!a){return false}g=a.data.pid;try{if(g=="0"){b=this.dataObj}else{var i=this.nodeById[g];if(!i){return}b=i.data;var c=a.outer.up("ul");if(c.children.length===1){i.expander.className=""}else{if(!a.outer.next("li")){var e=a.outer.previous("li");if(e){e.className="last"}}}}a.outer.remove();h=b.childs.indexOf(a.data);b.childs.splice(h,1);delete this.nodeById[d]}catch(f){return false}return true},updateNode:function(b,a){}});Protopack.TreeSelect=Class.create(Protopack.Input,{options:{className:"ptreeselect",interactive:false,multiSelect:false,fullPath:true,pathSep:" > "},initialize:function(b,a){this.options=Object.clone(this.options);Object.extend(this.options,a||{});this.options.readonly=true;this.className=this.options.className;this.multiSelect=this.options.multiSelect;this.buttonStyle="disabled";this.dropdownStyle="auto";this.value=[];this.xhtml=this.construct();if(b){$(b).insert(this.xhtml);this.render();}Protopack.extendEvents(this)},construct:function($super){var a=$super();entry=new Element("input",{type:"hidden"});options={multiSelect:this.multiSelect,interactive:this.options.interactive},tree=new Protopack.Tree(null,options);tree.observe("tree:click",this.select.bind(this));this.valueEntry=entry;this.tree=tree;a.insert(entry);return a.insert(this.dropdown.setContent(tree.xhtml))},select:function(a){if(this.multiSelect){this.value=this.valueEntry.value=this.tree.selected}else{this.value=this.valueEntry.value=a.data.id;this.dropdown.close()}this.text=this.entry.value=this.fetchText(this.tree.selected);this.fire("treeselect:change",this.value)},fetchText:function(c){var a=[];if(Object.isArray(c)){c.each(function(f){var e=this.tree.getNode(f);if(e){a.push(e.data.text)}},this);return a.join(", ")}else{var b=this.tree.getNode(c);if(b){if(this.options.fullPath){var d=c;while(d!="0"){a.push(this.tree.getNode(d).data.text);d=this.tree.getNode(d).data.pid}return a.reverse().join(this.options.pathSep)}else{return b.data.text}}}return null},loadData:function(a){this.tree.loadData(a);this.render()},setId:function(a){this.xhtml.id=a},setName:function(a){this.valueEntry.name=a},setValue:function(a){this.tree.select(a);this.value=this.valueEntry.value=a=this.tree.selected;this.text=this.fetchText(a);this.entry.value=this.text},selectAll:function(){this.tree.selectAll();this.setValue(this.tree.selected)},clear:function(){this.tree.clear();this.value=this.valueEntry.value=this.tree.selected;this.entry.value=this.text=""},insertNode:function(a){this.tree.insertNode(a)},deleteNode:function(a){this.tree.deleteNode(a)},updateNode:function(b,a){this.tree.updateNode(b,a)}});Protopack.Draggable=Class.create({options:{transparent:true},initialize:function(c,b,a){if(c===undefined){return}if(b===undefined){b=c}this.options=Object.clone(this.options);Object.extend(this.options,a||{});this.dragObj=c;this.clickObj=b;this.goDragFunc=this.goDrag.bindAsEventListener(this);this.stopDragFunc=this.stopDrag.bindAsEventListener(this);Event.observe(b,"mousedown",this.startDrag.bindAsEventListener(this))},startDrag:function(a){if(Event.isLeftClick(a)){this.cursorOffset=[Event.pointerX(a)-this.dragObj.offsetLeft,Event.pointerY(a)-this.dragObj.offsetTop];Event.observe(document,"mousemove",this.goDragFunc);Event.observe(this.clickObj,"mouseup",this.stopDragFunc);Event.stop(a);this.dragObj.absolutize();if(this.options.transparent){this.dragObj.setOpacity(0.9)}}},stopDrag:function(a){Event.stopObserving(document,"mousemove",this.goDragFunc);Event.stopObserving(this.clickObj,"mouseup",this.stopDragFunc);this.dragObj.relativize();if(this.options.transparent){this.dragObj.setOpacity(1)}},goDrag:function(b){var a=Event.pointerX(b),c=Event.pointerY(b);this.dragObj.style.left=a-this.cursorOffset[0]+"px";this.dragObj.style.top=c-this.cursorOffset[1]+"px";Event.stop(b)}});Protopack.Window=Class.create({options:{className:"pwindow",modal:true,draggable:true,transparentDrag:true,escape:true,autoClose:false,showHeader:true,closeButton:true,autoCenter:true},initialize:function(a,b){this.options=Object.clone(this.options);Object.extend(this.options,a||{});this.className=this.options.className;this.focusHandler=this.onLostFocus.bind(this);this.escapeHandler=this.onEscape.bind(this);this.excludedElements=[];b=(b===undefined)?document.body:$(b);if(this.window){this.destroy()}this.window=this.construct(b);this.setPosition()},construct:function(c){var b=this.buildWindow();if(this.options.modal){this.overlay=this.buildOverlay(c)}if(this.options.showHeader){this.header=this.buildHeader();b.insert(this.header)}this.body=this.buildBody();b.insert(this.body);if(this.options.closeButton){b.insert(this.buildClose())}c.insert(b);if(this.options.draggable){if(typeof Protopack.Draggable!=="undefined"){new Protopack.Draggable(b,this.header?this.header:b,{transparent:this.options.transparentDrag})}else{if(typeof Draggable!=="undefined"){var a={};if(!this.options.transparentDrag){a={starteffect:false,endeffect:false}}new Draggable(b,a)}}}return b},buildWindow:function(){return new Element("div",{"class":this.className}).hide()},buildOverlay:function(b){var a=new Element("div",{"class":this.className+"-overlay"});a.style.position=(b===document.body)?"fixed":"absolute";a.observe("mousedown",function(c){if(this.options.autoClose){this.close()}else{Event.stop(c)}}.bind(this));b.insert(a.hide());return a},buildHeader:function(){var b=new Element("div",{"class":this.className+"-header"}),a=new Element("div",{"class":this.className+"-title"});this.title=a;return b.insert(a)},buildBody:function(){var a=new Element("div",{"class":this.className+"-body"}),b=new Element("div",{"class":this.className+"-content"});this.content=b;return a.insert(b)},buildClose:function(){var a=new Element("span",{"class":this.className+"-close"});a.observe("click",this.close.bind(this));return a},startDocEvents:function(){if(this.options.autoClose){document.observe("mousedown",this.focusHandler)}if(this.options.escape){document.observe("keydown",this.escapeHandler)}},stopDocEvents:function(){document.stopObserving("mousedown",this.focusHandler);document.stopObserving("keydown",this.escapeHandler)},onEscape:function(a){if(this.window.visible()&&a.keyCode===Event.KEY_ESC){this.close()}},onLostFocus:function(b){var a=b.findElement();if(this.window.visible()&&this.window!==a&&this.window.descendants().indexOf(a)===-1&&this.excludedElements.indexOf(a)===-1){this.close()}},setPosition:function(b,g){if(b!==undefined&&g!==undefined){try{this.window.style.left=b+"px";this.window.style.top=g+"px"}catch(d){throw"Could not set window position."}}else if(this.options.autoCenter){var c=this.window.getWidth(),a=this.window.getHeight(),f,e;if(this.window.parentNode===document.body){e=document.viewport.getDimensions();f=document.viewport.getScrollOffsets();e.width+=2*f.left;e.height+=2*f.top}else{e=this.window.parentNode.getDimensions()}this.window.style.left=(c>e.width)?0:Math.round(e.width/2-c/2)+"px";this.window.style.top=(a>e.height)?0:Math.round(e.height/2-a/2)+"px"}},setId:function(a){this.window.id=a},setTitle:function(a){if(this.title){this.title.update(a)}},setContent:function(a){this.content.update(a)},setSize:function(b,a){this.window.style.width=b+"px";this.window.style.height=a+"px"},open:function(a,b){if(a!==undefined&&b!==undefined){this.setPosition(a,b)}this.window.show();if(this.options.modal){this.overlay.show()}this.startDocEvents()},close:function(){this.stopDocEvents();this.window.hide();if(this.overlay){this.overlay.hide()}if(this.onClose){this.onClose()}},toggle:function(){if(this.window.visible()){this.close()}else{this.open()}},destroy:function(){this.window.remove();if(this.overlay){this.overlay.remove();this.overlay=null}}});