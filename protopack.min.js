/**
 * Protopack is set of DHTML UI Components based on Prototype JS framework
 *
 * @author      Mohsen Khahani <mkhahani@gmail.com>
 * @copyright   2011-2013 Mohsen Khahani
 * @license     MIT
 * @version     1.0dev
 * @url         http://mohsenkhahani.ir/protopack
 */

if(typeof Prototype==="undefined"||!Prototype.Version.match("1.7")){throw ("Protopack requires Prototype JavaScript framework 1.7.0+")}var Protopack=Protopack||{version:"1.0dev",extendEvents:function(a){Object.extend(a,{initObserve:function(b){this.observers=this.observers||{};this.observers[b]=this.observers[b]||[]},observe:function(c,b){this.initObserve(c);if(!this.observers[c].include(b)){this.observers[c].push(b)}},fire:function(d){this.initObserve(d);if(this.observers[d]!==undefined){for(var c=0;c<this.observers[d].length;c++){var b=$A(arguments).slice(1);this.observers[d][c].apply(this,b)}}}})}};if(Object.isUndefined(Prototype.Browser.IE6)){Prototype.Browser.IE6=(navigator.appName.indexOf("Microsoft Internet Explorer")!=-1&&navigator.appVersion.indexOf("MSIE 6.0")!=-1&&!window.XMLHttpRequest)}Element.addMethods({getInnerText:function(a){a=$(a);return(a.innerText&&!window.opera)?a.innerText:a.innerHTML.stripScripts().unescapeHTML().replace(/[\n\r\s]+/g," ")}});function addCommas(f,g){var d=/(\d+)(\d{3})/,a,c,b,e;f+="";a=f.split(".");c=a[0];b=a.length>1?"."+a[1]:"";while(d.test(c)){c=c.replace(d,"$1,$2")}e=c+b;if(!e.blank()&&g!==undefined){e=g+e}return e}Protopack.Input=Class.create({options:{className:"pinput",readonly:true,buttonStyle:"smart",dropdownStyle:"auto"},initialize:function(b,a){this.options=Object.clone(this.options);Object.extend(this.options,a||{});this.className=this.options.className;this.buttonStyle=this.options.buttonStyle;this.dropdownStyle=this.options.dropdownStyle;if(b){this.target=$(b);this.xhtml=this.construct()}},construct:function(){var a=new Element("div",{"class":this.className});this.entry=this.buildEntry();a.insert(this.entry);if(this.buttonStyle!=="disabled"){this.button=this.buildButton(a);a.insert(this.button)}if(this.dropdownStyle!=="disabled"){this.dropdown=this.buildDropdown(a)}if(this.target){this.target.insert(a)}return a},buildEntry:function(){var a=(this.entry)?(this.entry):new Element("input",{type:"text"});if(this.options.readonly){a.writeAttribute({readonly:true})}if(this.buttonStyle==="smart"){a.observe("mousedown",function(){this.button.hide()}.bind(this))}a.observe("mousedown",this.click.bind(this));return a},buildButton:function(b){var a=new Element("button");if(this.buttonStyle==="smart"){a.hide();b.observe("mouseover",function(){a.show()}.bind(this));b.observe("mouseout",function(){a.hide()}.bind(this))}a.observe("click",this.buttonClick.bind(this));return a},buildDropdown:function(b){var a={className:this.className+"-dropdown",modal:false,draggable:false,showHeader:false,closeButton:false,autoClose:true,autoCenter:false},c=new Protopack.Window(a,b);c.excludedElements.push(this.entry);return c},click:function(a){if(this.dropdownStyle==="auto"&&Event.isLeftClick(a)){this.dropdown.toggle()}},buttonClick:function(a){if(this.dropdownStyle==="auto"){this.dropdown.toggle()}},get:function(){return this.xhtml},grab:function(a){this.entry=$(a);this.xhtml.update();this.xhtml=this.construct()},render:function(){this.dropdown.window.style.top=this.entry.getHeight()+1+"px"},setId:function(a){this.entry.id=a},setName:function(a){this.entry.name=a},setText:function(a){this.entry.value=a},openUp:function(){this.dropdown.open()}});Protopack.Tree=Class.create({options:{className:"ptree",interactive:true,multiSelect:false,includeRoot:true,rootId:0},initialize:function(b,a){this.options=Object.clone(this.options);Object.extend(this.options,a||{});this.multiSelect=this.options.multiSelect;this.rootId=this.options.rootId;this.selected=(this.multiSelect)?[]:null;this.nodeById={};this.xhtml=this.construct(b);Protopack.extendEvents(this)},construct:function(b){var a=new Element("div",{"class":this.options.className});if(b){$(b).update(a)}a.observe("node:click",this.click.bind(this));a.observe("node:mouseover",this.mouseOver.bind(this));a.observe("node:mouseout",this.mouseOut.bind(this));a.observe("node:toggle",this.toggle.bind(this));a.observe("node:create",this.nodeCreate.bind(this));return a},loadData:function(d){var a,b=function(g,j){var e=d.partition(function(i){return i[1]==g}),f;d=e[1];for(f=0;f<e[0].length;f++){var k=e[0][f],h=j.addNode(k[0],k[1],k[2],k[3]||null);if(d.length>0){b(k[0],h)}}};this.dataObj=new Protopack.Tree.Data(this.rootId,this.rootId-1,"/",null);b(this.rootId,this.dataObj);if(this.options.includeRoot){this.nodeById[this.rootId]=this.dataObj;a=this.createChilds([this.dataObj])}else{a=this.createChilds(this.dataObj.childs)}this.xhtml.update(a);try{a.down("li").addClassName("first")}catch(c){}},createNode:function(c,a){var b=null;this.fire("tree:nodecreate",c,b);nodeObj=new Protopack.Tree.Node(c,b,a);nodeObj.element.addClassName("node");if(this.multiSelect){if(nodeObj.data.extra.checked){this.selected.push(nodeObj.data.id)}}return nodeObj},createChilds:function(a){var c=new Element("ul"),b={multiSelect:this.multiSelect,interactive:this.options.interactive},d;a.each(function(f,e){d=this.createNode(f,b);if(f.childs.length>0){d.expander.addClassName("close")}if(e===a.length-1){d.outer.addClassName("last")}c.insert(d.outer);this.nodeById[f.id]=d}.bind(this));return c},getChilds:function(b){var a=b.element.next("ul");if(a===undefined){a=this.createChilds(b.data.childs);b.outer.insert(a)}return a},selectNode:function(a){if(this.nodeById[a]===undefined){return}if(this.multiSelect){if(this.selected.indexOf(a)===-1){this.selected.push(a)}this.nodeById[a].data.extra.checked=true;this.nodeById[a].element.down("input").checked=true}else{this.nodeById[a].element.addClassName("selected");this.selected=a}},deselectNode:function(a){if(this.nodeById[a]===undefined){return}if(this.multiSelect){this.nodeById[a].data.extra.checked=false;this.nodeById[a].element.down("input").checked=false;this.selected.splice(this.selected.indexOf(a),1)}else{this.nodeById[a].element.removeClassName("selected");this.selected=null}}});Protopack.Tree.Data=Class.create({initialize:function(d,b,c,a){this.id=d;this.pid=b;this.text=c;this.extra=a||{};this.childs=[]},getNode:function(b){if(this.id==b){return this}var a=false;this.childs.each(function(c){if(c.id==b){a=c;throw $break}});if(a===false){this.childs.each(function(c){a=c.getNode(b);if(a){throw $break}})}return a},addNode:function(f,b,e,a){var c=this.getNode(b),d=new Protopack.Tree.Data(f,b,e,a);c.childs.push(d);return d},deleteNode:function(c){var a=this.getNode(pid),b=new Protopack.Tree.Data(c,pid,text,extra);a.childs.push(b);return b},getChildren:function(a){var b=this.childs.clone();if(a){this.childs.each(function(d){var c=d.getChildren(true);b=b.concat(c)})}return b}});Protopack.Tree.Node=Class.create({initialize:function(c,b,a){this.data=c;this.inner=b;this.options={};Object.extend(this.options,a||{});this.outer=this.construct()},construct:function(){var b=new Element("li"),c=new Element("span"),a=new Element("div");if(!this.inner){this.inner=this.buildNode()}a.insert(this.inner);a.observe("click",this.click.bind(this));a.observe("mouseover",this.mouseOver.bind(this));a.observe("mouseout",this.mouseOut.bind(this));this.element=a;c.observe("click",this.toggle.bind(this)),b.insert(c);this.expander=c;b.insert(a);return b},buildNode:function(){var a;if(this.options.multiSelect){var b=new Element("input",{type:"checkbox",value:this.data.id});a=new Element("div");if(typeof this.data.checked!="undefined"){b.writeAttribute({checked:this.data.checked})}else{this.data.checked=false}a.insert(b);a.insert(new Element("label").update(this.data.text))}else{a=new Element("a").update(this.data.text)}return a},click:function(){this.element.fire("node:click",this)},mouseOver:function(){this.element.fire("node:mouseover",this)},mouseOut:function(){this.element.fire("node:mouseout",this)},toggle:function(){this.element.fire("node:toggle",this)}});Protopack.Tree.addMethods({click:function(a){var b=a.memo.data.id;if(this.multiSelect){if(a.memo.data.extra.checked){this.deselectNode(b)}else{this.selectNode(b)}}else{this.deselectNode(this.selected);this.selectNode(b)}this.fire("tree:click",a.memo)},mouseOver:function(a){a.memo.element.addClassName("hover");this.fire("tree:mouseover",a.memo)},mouseOut:function(a){a.memo.element.removeClassName("hover");this.fire("tree:mouseout",a.memo)},toggle:function(a){var b=a.memo.data.id;if(a.memo.expander.className==="close"){this.expand(b)}else{this.collapse(b)}this.fire("tree:toggle",a.memo)},nodeCreate:function(a){this.fire("tree:nodecreate",a.memo)}});Protopack.Tree.addMethods({getNode:function(a){return this.nodeById[a]},setId:function(a){this.xhtml.id=a},setClassName:function(a){this.xhtml.className=a},setCaption:function(a){if(this.caption){this.caption.update(a)}else{this.caption=new Element("div",{"class":"caption"}).update(a);this.xhtml.insert({top:this.caption})}return this.caption},expand:function(c,a){if(!this.nodeById[c]){return}var b=this.nodeById[c];this.getChilds(b).show();if(b.data.childs.length>0){b.expander.className="open"}if(a){b.data.childs.each(function(d){this.expand(d.id,true)},this)}},collapse:function(c,a){if(!this.nodeById[c]){return}var b=this.nodeById[c];this.getChilds(b).hide();if(b.data.childs.length>0){b.expander.className="close"}if(a){b.data.childs.each(function(d){this.collapse(d.id,true)},this)}},expandAll:function(){if(this.options.includeRoot){this.expand(this.rootId,true)}else{this.dataObj.childs.each(function(a){this.expand(a.id,true)},this)}},collapseAll:function(){if(this.options.includeRoot){this.collapse(this.rootId,true)}else{this.dataObj.childs.each(function(a){this.collapse(a.id,true)},this)}},select:function(a){if(this.multiSelect){a=Object.isArray(a)?a.uniq():[a];a.each(function(b){this.selectNode(b)},this)}else{this.selectNode(a)}},selectAll:function(){if(this.multiSelect){this.select(Object.keys(this.nodeById))}},clear:function(){if(this.multiSelect){var b=this.selected.clone();for(var a=0;a<b.length;a++){this.deselectNode(b[a])}this.selected.clear()}else{this.deselectNode(this.selected)}},insertNode:function(d,h,j,f){var e,a,b,c;if(h=="0"){b=this.dataObj;c=this.xhtml.down("ul")}else{var i=this.nodeById[h];if(!i){return}b=i.data;c=this.getChilds(i);i.expander.className="open"}e=b.addNode(d,h,j,f);a=this.createNode(e);c.insert(a.outer);a.outer.addClassName("last");this.nodeById[d]=a;try{a.outer.previous("li").removeClassName("last")}catch(g){}return a},deleteNode:function(d){var a=this.nodeById[d],b,h,g;if(!a){return false}g=a.data.pid;try{if(g=="0"){b=this.dataObj}else{var i=this.nodeById[g];if(!i){return}b=i.data;var c=a.outer.up("ul");if(c.children.length===1){i.expander.className=""}else{if(!a.outer.next("li")){var e=a.outer.previous("li");if(e){e.className="last"}}}}a.outer.remove();h=b.childs.indexOf(a.data);b.childs.splice(h,1);delete this.nodeById[d]}catch(f){return false}return true},updateNode:function(b,a){}});Protopack.TreeSelect=Class.create(Protopack.Input,{options:{className:"ptreeselect",interactive:false,multiSelect:false,includeRoot:false,fullPath:true,pathSep:" > ",defaultText:""},initialize:function(b,a){this.options=Object.clone(this.options);Object.extend(this.options,a||{});this.options.readonly=true;this.className=this.options.className;this.multiSelect=this.options.multiSelect;this.buttonStyle="disabled";this.dropdownStyle="auto";this.value=[];this.xhtml=this.construct();this.setText(this.options.defaultText);if(b){$(b).insert(this.xhtml);this.render()}Protopack.extendEvents(this)},construct:function($super){var a=$super();entry=new Element("input",{type:"hidden"});options={multiSelect:this.multiSelect,interactive:this.options.interactive,includeRoot:this.options.includeRoot},tree=new Protopack.Tree(null,options);tree.observe("tree:click",this.select.bind(this));this.valueEntry=entry;this.tree=tree;a.insert(entry);return a.insert(this.dropdown.setContent(tree.xhtml))},select:function(a){if(this.multiSelect){this.value=this.valueEntry.value=this.tree.selected}else{this.value=this.valueEntry.value=a.data.id;this.dropdown.close()}this.setText(this.fetchText(this.value));this.fire("treeselect:change",this.value)},fetchText:function(c){var a=[];if(c.length===0){return this.options.defaultText}if(Object.isArray(c)){c.each(function(e){var d=this.tree.getNode(e);if(d){a.push(d.data.text)}},this);return a.join(", ")}else{var b=this.tree.getNode(c);if(b){if(this.options.fullPath){while(b){a.push(b.data.text);b=this.tree.getNode(b.data.pid)}return a.reverse().join(this.options.pathSep)}else{return b.data.text}}}return null},loadData:function(a){this.tree.loadData(a);this.render()},setId:function(a){this.xhtml.id=a},setName:function(a){this.valueEntry.name=a},setText:function(a){this.text=a;this.entry.value=a;this.entry.title=a},setValue:function(a){this.tree.clear();this.tree.select(a);this.value=this.valueEntry.value=a=this.tree.selected;this.setText(this.fetchText(this.value))},selectAll:function(){this.tree.selectAll();this.setValue(this.tree.selected)},clear:function(){this.tree.clear();this.value=this.valueEntry.value=this.tree.selected;this.setText(this.options.defaultText)},insertNode:function(a){this.tree.insertNode(a)},deleteNode:function(a){this.tree.deleteNode(a)},updateNode:function(b,a){this.tree.updateNode(b,a)}});Protopack.Draggable=Class.create({options:{transparent:true},initialize:function(c,b,a){if(c===undefined){return}if(b===undefined){b=c}this.options=Object.clone(this.options);Object.extend(this.options,a||{});this.dragObj=c;this.clickObj=b;this.goDragFunc=this.goDrag.bindAsEventListener(this);this.stopDragFunc=this.stopDrag.bindAsEventListener(this);Event.observe(b,"mousedown",this.startDrag.bindAsEventListener(this))},startDrag:function(a){if(Event.isLeftClick(a)){this.cursorOffset=[Event.pointerX(a)-this.dragObj.offsetLeft,Event.pointerY(a)-this.dragObj.offsetTop];Event.observe(document,"mousemove",this.goDragFunc);Event.observe(this.clickObj,"mouseup",this.stopDragFunc);Event.stop(a);this.dragObj.absolutize();if(this.options.transparent){this.dragObj.setOpacity(0.9)}}},stopDrag:function(a){Event.stopObserving(document,"mousemove",this.goDragFunc);Event.stopObserving(this.clickObj,"mouseup",this.stopDragFunc);this.dragObj.relativize();if(this.options.transparent){this.dragObj.setOpacity(1)}},goDrag:function(b){var a=Event.pointerX(b),c=Event.pointerY(b);this.dragObj.style.left=a-this.cursorOffset[0]+"px";this.dragObj.style.top=c-this.cursorOffset[1]+"px";Event.stop(b)}});Protopack.Window=Class.create({options:{className:"pwindow",modal:true,draggable:true,transparentDrag:true,escape:true,autoClose:false,showHeader:true,closeButton:true,autoCenter:true},initialize:function(a,b){this.options=Object.clone(this.options);Object.extend(this.options,a||{});this.className=this.options.className;this.focusHandler=this.onLostFocus.bind(this);this.escapeHandler=this.onEscape.bind(this);this.excludedElements=[];b=(b===undefined)?document.body:$(b);if(this.window){this.destroy()}this.window=this.construct(b)},construct:function(c){var b=this.buildWindow();if(this.options.modal){this.overlay=this.buildOverlay(c)}if(this.options.showHeader){this.header=this.buildHeader();b.insert(this.header)}this.body=this.buildBody();b.insert(this.body);if(this.options.closeButton){b.insert(this.buildClose())}c.insert(b);if(this.options.draggable){if(typeof Protopack.Draggable!=="undefined"){new Protopack.Draggable(b,this.header?this.header:b,{transparent:this.options.transparentDrag})}else{if(typeof Draggable!=="undefined"){var a={};if(!this.options.transparentDrag){a={starteffect:false,endeffect:false}}new Draggable(b,a)}}}return b},buildWindow:function(){return new Element("div",{"class":this.className}).hide()},buildOverlay:function(b){var a=new Element("div",{"class":this.className+"-overlay"});a.style.position=(b===document.body)?"fixed":"absolute";a.observe("mousedown",function(c){if(this.options.autoClose){this.close()}else{Event.stop(c)}}.bind(this));b.insert(a.hide());return a},buildHeader:function(){var b=new Element("div",{"class":this.className+"-header"}),a=new Element("div",{"class":this.className+"-title"});this.title=a;return b.insert(a)},buildBody:function(){var a=new Element("div",{"class":this.className+"-body"}),b=new Element("div",{"class":this.className+"-content"});this.content=b;return a.insert(b)},buildClose:function(){var a=new Element("span",{"class":this.className+"-close"});a.observe("click",this.close.bind(this));return a},startDocEvents:function(){if(this.options.autoClose){document.observe("mousedown",this.focusHandler)}if(this.options.escape){document.observe("keydown",this.escapeHandler)}},stopDocEvents:function(){document.stopObserving("mousedown",this.focusHandler);document.stopObserving("keydown",this.escapeHandler)},onEscape:function(a){if(this.window.visible()&&a.keyCode===Event.KEY_ESC){this.close()}},onLostFocus:function(b){var a=b.findElement();if(this.window.visible()&&this.window!==a&&this.window.descendants().indexOf(a)===-1&&this.excludedElements.indexOf(a)===-1){this.close()}},setPosition:function(b,g){if(b!==undefined&&g!==undefined){try{this.window.style.left=b+"px";this.window.style.top=g+"px"}catch(d){throw"Could not set window position."}}else{if(this.options.autoCenter){var c=this.window.getWidth(),a=this.window.getHeight(),f,e;if(this.window.parentNode===document.body){e=document.viewport.getDimensions();f=document.viewport.getScrollOffsets();e.width+=2*f.left;e.height+=2*f.top}else{e=this.window.parentNode.getDimensions()}this.window.style.left=(c>e.width)?0:Math.round(e.width/2-c/2)+"px";this.window.style.top=(a>e.height)?0:Math.round(e.height/2-a/2)+"px"}}},setId:function(a){this.window.id=a},setTitle:function(a){if(this.title){this.title.update(a)}},setContent:function(a){this.content.update(a)},setSize:function(b,a){this.window.style.width=b+"px";this.window.style.height=a+"px"},open:function(a,b){if(!this.window.style.left){this.setPosition(a,b)}this.window.show();if(this.options.modal){this.overlay.show()}this.startDocEvents()},close:function(){this.stopDocEvents();this.window.hide();if(this.overlay){this.overlay.hide()}if(this.onClose){this.onClose()}},toggle:function(){if(this.window.visible()){this.close()}else{this.open()}},destroy:function(){this.window.remove();if(this.overlay){this.overlay.remove();this.overlay=null}}});Protopack.Tabs=Class.create({options:{className:"ptabs",findTabs:true,hover:false,defaultTab:1},initialize:function(b,a){if(!$(b)){throw new Error('Protopack.Tabs.initialize(): Could not find the target element "'+b+'".')}this.target=$(b);this.options=Object.clone(this.options);Object.extend(this.options,a||{});if(this.options.findTabs){this.construct()}},construct:function(){var a=this.target.select("li a");this.tabs=this.target.select("li").invoke("addClassName",this.options.className+"-tab");this.sheets=a.map(function(b){return $(b.rel)});a.invoke("observe","click",this.switchTab.bind(this));if(this.options.hover){a.invoke("observe","mouseover",this.switchTab.bind(this))}this.reset();this.setActive(this.options.defaultTab);this.target.addClassName(this.options.className)},createTabs:function(b){var a=new Element("ul").addClassName(this.options.className);this.sheets=b.map(function(c){return $(c[0])});this.tabs=b.map(function(e){var d=new Element("a",{rel:e[0]}).update(e[1]),c=new Element("li").insert(d);d.observe("click",this.switchTab.bind(this));if(this.options.hover){d.observe("mouseover",this.switchTab.bind(this))}c.addClassName(this.options.className+"-tab");a.insert(c);return c}.bind(this));return a},switchTab:function(b){var a=Event.findElement(b);this.reset();$(a.rel).show();a.up("li").addClassName("active")},reset:function(){this.sheets.invoke("hide");this.tabs.invoke("removeClassName","active")},setTabs:function(a){this.target.insert({top:this.createTabs(a)});this.reset();this.setActive(this.options.defaultTab)},setActive:function(a){this.reset();this.tabs[a-1].addClassName("active");this.sheets[a-1].show()}});Protopack.Grid=Class.create({options:{className:"pgrid",header:true,footer:true,sorting:"client",filtering:false,pagination:false,keyboard:false,rowSelect:true,cellSelect:false,rowHover:false,cellHover:false,rowClasses:false,colClasses:false,oddEvenRows:true,currencySymbol:"$"},initialize:function(e,c,a,b){var d={};this.options=Object.clone(this.options);Object.extend(this.options,a||{});this.events=b||{};this._columns=c||[];this._columns.each(function(f){d[f.name]=f});this._columnsByName=d;this._className=this.options.className;this._pageIndex=1;this._pageBy=0;this._backupData=null;this.grid=this._construct(e);Protopack.extendEvents(this)},_construct:function(e){var c=new Element("div",{"class":this._className}),b=new Element("tbody"),d=new Element("table").update(b),a=new Element("div",{"class":this._className+"-body"}).update(d);if(this.options.header){this.header=this._createHeader();c.insert(this.header)}a.tabIndex="1";a.observe("click",this._click.bind(this));a.observe("dblclick",this._dblClick.bind(this));a.observe("mouseover",this._mouseOver.bind(this));a.observe("mouseout",this._mouseOut.bind(this));if(this.options.keyboard){a.observe("keydown",this._keyDown.bind(this))}this.body=a;this.table=d;this._createColumns();c.insert(this.body);if(this.options.footer){this.footer=this._createFooter();c.insert(this.footer)}$(e).insert(c);return c},_createHeader:function(){var f=new Element("div",{"class":this._className+"-header"}),c=new Element("table"),a=c.insertRow(-1),d=c.insertRow(-1),e=0;this._columns.each(function(g){if(e>0){e--;return}var h=new Element("th");if(g.hidden){h.addClassName("hidden");h.setAttribute("width",0)}else{h.addClassName("t-"+g.name);if(g.image){h.insert(new Element("img",{src:g.image}))}if(g.width){h.setAttribute("width",g.width)}if(this.options.sorting&&g.sortType){h.addClassName("sortable")}}a.className="titles";Element.insert(a,h.insert(g.title));if(g.hasOwnProperty("colSpan")){h.setAttribute("colspan",g.colSpan);e=g.colSpan-1}}.bind(this));if(this.options.sorting){Event.observe(a,"click",this._sort.bind(this))}if(this.options.filtering){var b=new Element("form");f.insert(b.insert(c));e=0;d.className="filters";this._columns.each(function(i){if(e>0){e--;return}var k=new Element("td");if(i.hidden){k.addClassName("hidden");k.setAttribute("width",0)}else{if(i.filter){var j=(this.options.filtering==="client")?this.filter:this.events.onFilter;switch(i.filter){case"text":var h=new Element("input",{name:i.name});if(i.width){h.style.width=i.width+"px"}k.insert(h);break;case"list":var g=new Element("select",{name:i.name});g.style.width=i.width+"px";k.insert(g);break}}}Element.insert(d,k);if(i.hasOwnProperty("colSpan")){k.setAttribute("colspan",i.colSpan);e=i.colSpan-1}}.bind(this));Event.observe(d,"change",this._filter.bind(this))}else{f.insert(c)}return f},_createFooter:function(){var h=new Element("div",{"class":this._className+"-footer"});if(this.options.pagination){var a=new Element("table",{"class":this._className+"-pager"}),f=a.insertRow(-1),c=new Element("span",{"class":this._className+"-status"}),g=new Element("input",{type:"text",value:"1"}),d=new Element("input",{type:"button","class":"first"}),b=new Element("input",{type:"button","class":"prev"}),e=new Element("input",{type:"button","class":"next"}),i=new Element("input",{type:"button","class":"last"});e.observe("click",function(){this._goToPage("next")}.bind(this));b.observe("click",function(){this._goToPage("prev")}.bind(this));i.observe("click",function(){this._goToPage("last")}.bind(this));d.observe("click",function(){this._goToPage("first")}.bind(this));g.observe("keydown",function(j){if(j.keyCode===13){this._goToPage(g.value)}}.bind(this));this.pgNext=e;this.pgPrev=b;this.pgLast=i;this.pgFirst=d;this.pageInput=g;this.status=c;a.insert(new Element("tr"));f.insert(new Element("td").insert(c));f.insert(new Element("td").insert(d));f.insert(new Element("td").insert(b));f.insert(new Element("td").insert(g));f.insert(new Element("td").insert(e));f.insert(new Element("td").insert(i));h.insert(a)}return h},_createColumns:function(){var a=this.table.createTHead(),c=a.insertRow(-1),b=0,d=0;this._columns.each(function(f,e){if(d>0){d--;return}var g=new Element("th");if(f.hidden){g.addClassName("hidden");g.setAttribute("width",0)}else{if(f.align){g.setAttribute("align",f.align)}if(f.width){g.setAttribute("width",f.width)}b++}Element.insert(c,g);if(f.hasOwnProperty("colSpan")){g.setAttribute("colspan",f.colSpan);d=f.colSpan-1}}.bind(this))},_insertRow:function(c,a){var b=this.table.tBodies[0].insertRow(a);this._createCells(b,c);return b},_createCells:function(b,a){this._columns.each(function(g,d){var c=b.insertCell(-1),e=Object.isArray(a)?d:g.name,f=this._createElement(g,a[e]);if(this.options.colClasses){c.addClassName("c-"+e)}if(g.hidden){c.addClassName("hidden")}else{if(g.align){c.setAttribute("align",g.align)}}Element.insert(c,f)}.bind(this))},_createElement:function(a,d){var b;switch(a.type){case"id":b=d;break;case"text":if(Object.isString(d)||Object.isNumber(d)){b=new Element("span").update(d)}else{b=new Element("span").update(d.text)}break;case"currency":var c=(Object.isString(d)||!isNaN(d))?d:d.text;c=addCommas(c,this.options.currencySymbol);b=new Element("span").update(c);break;case"image":if(Object.isString(d)){b=new Element("img",{src:d})}else{b=new Element("img",{src:d.src});if(d.hasOwnProperty("alt")){b.setAttribute("alt",d.alt)}}break;case"link":if(Object.isString(d)){b=new Element("a",{href:d}).update(d)}else{b=new Element("a",{href:d.href});if(d.hasOwnProperty("text")){b.update(d.text)}if(d.hasOwnProperty("image")){b.insert(new Element("img"),{src:d.image})}}break}if(typeof d=="object"){if(d.hasOwnProperty("title")){b.setAttribute("title",d.title)}if(d.hasOwnProperty("style")){b.setAttribute("style",d.style)}}return b},_load:function(a){if(a){$(this.table.tBodies[0]).update();this.data=a;a.each(function(b){this._insertRow(b,-1)}.bind(this))}this.refresh()},_highlightRow:function(a){a.addClassName("hover")},_unHighlightRow:function(a){a.removeClassName("hover")},_highlightCell:function(a){a.addClassName("hover")},_unHighlightCell:function(a){a.removeClassName("hover")},_selectRow:function(a){if(this.selectedRow){this.selectedRow.removeClassName("selected")}if(a){a.addClassName("selected")}this.selectedRow=a},_selectCell:function(a){if(this.selectedCell){this.selectedCell.removeClassName("selected")}if(a){a.addClassName("selected")}this.selectedCell=a},_goToPage:function(a){if(!isNaN(a)){if(a>=1||a<=this.maxPageIndex){this._pageIndex=a}else{return}}else{switch(a){case"next":if(this._pageIndex<this.maxPageIndex){this._pageIndex++}else{return}break;case"prev":if(this._pageIndex>1){this._pageIndex--}else{return}break;case"last":if(this._pageIndex<this.maxPageIndex){this._pageIndex=this.maxPageIndex}else{return}break;case"first":if(this._pageIndex>1){this._pageIndex=1}else{return}break;default:return}}this.initFunc(this._pageIndex);this._updatePager();if(this._backupData!==null){this._backupData=null;this.filter(this._filterParams)}},_updatePager:function(){if(this.footer){if(this.total===0){this.status.update("")}else{var b=(this._pageIndex-1)*this._pageBy+1,a=this._pageIndex*this._pageBy;if(a===0||a>this.total){a=this.total}if(this.options.pagination){this.status.update(b+" - "+a+" ("+this.total+")");this.pageInput.setValue(this._pageIndex)}}}},resetPager:function(){this._pageIndex=1;this._updatePager()}});Protopack.Grid.addMethods({_click:function(b){var c=b.findElement("td"),a=c.up("tr");if(c===document||a===undefined){return}if(this.options.rowSelect){this._selectRow(a)}if(this.options.cellSelect){this._selectCell(c)}this.fire("grid:click",a.sectionRowIndex,c.cellIndex,b)},_dblClick:function(b){var c=b.findElement("td"),a=c.up("tr");if(c!==document&&a!==undefined){this.fire("grid:dblclick",a.sectionRowIndex,c.cellIndex,b)}},_mouseOver:function(b){var a=b.findElement("tr"),c=b.findElement("td");if(a!==document){if(this.options.rowHover){this._highlightRow(a)}this.fire("grid:rowover",a.sectionRowIndex,b)}if(c!==document){a=c.up("tr");if(this.options.cellHover){this._highlightCell(c)}this.fire("grid:cellover",a.sectionRowIndex,c.cellIndex,b)}},_mouseOut:function(b){var a=b.findElement("tr"),c=b.findElement("td");if(a!==document){if(this.options.rowHover){this._unHighlightRow(a)}this.fire("grid:rowout",a.sectionRowIndex,b)}if(c!==document){a=c.up("tr");if(this.options.cellHover){this._unHighlightCell(c)}this.fire("grid:cellout",a.sectionRowIndex,c.cellIndex,b)}},_keyDown:function(f){var d=f.keyCode;if(this.options.rowSelect||this.options.cellSelect){if(d===40||d===38){var a=0,c;if(this.selectedCell){a=this.selectedCell.cellIndex;row=this.selectedCell.up("tr").sectionRowIndex+d-39}else{row=this.selectedRow?this.selectedRow.sectionRowIndex+d-39:0}c=this.table.tBodies[0].rows[row];if(c){if(this.options.rowSelect){this._selectRow(c)}if(this.options.rowCell){this._selectCell(c.cells[a])}}}if(this.options.cellSelect&&(d===37||d===39)){if(this.selectedCell){var a=this.selectedCell.cellIndex+d-38,c=this.selectedCell.up("tr"),b=c.cells[a];if(b){this._selectCell(b)}}}}this.fire("grid:keydown",f)},_sort:function(b){var c=b.findElement("th"),a;if(c===document){return}a=this._columns[c.cellIndex];if(!a.sortType){return}this._sortBy=a.name;this._sortOrder=(this._sortOrder==="ASC")?"DESC":"ASC";if(this.options.sorting==="client"){this.sort(this._sortBy,this._sortOrder)}else{this.fire("grid:sort",this._sortBy,this._sortOrder,b);this.setSort(this._sortBy,this._sortOrder)}},_filter:function(b){var a=b.findElement().up("form").serialize(true);if(this.options.filtering==="client"){this.filter(a)}else{this.fire("grid:filter",a,b)}}});Protopack.Grid.addMethods({init:function(a){this.initFunc=a;a(this._pageIndex)},setId:function(a){this.grid.id=a},pageBy:function(a){this._pageBy=a},setFilterList:function(c,b){if(!this.options.filtering){throw new Error("ProtopackGrid.setFilterList(): filter option is disabled")}var a=this.header.down("form")[c];if(Object.isArray(b)&&b.length>0){b.each(function(e){var d=new Element("option",{value:e[0]}).update(e[1]);a.insert(d)})}},loadData:function(b,a){this._load(b);this.total=(typeof a=="undefined")?b.length:a;if(this._pageBy!==0){this.maxPageIndex=Math.ceil(this.total/this._pageBy)}this._updatePager()},render:function(){var a=this.table.tHead.select("th").map(function(c,b){return c.hasClassName("hidden")?0:c.measure("width")});this.header.select("th").each(function(c,b){c.setAttribute("width",a[b]+"px")});if(this.table.getHeight()>this.body.getHeight()){this.header.setStyle("padding-right:16px")}else{this.header.setStyle("padding-right:0")}},reload:function(){this._load(this.data)},refresh:function(){var a=this.table.tBodies[0].select("tr");if(this.options.rowClasses){a.each(function(c,b){c.addClassName("r-"+b)})}if(this.options.oddEvenRows){a.each(function(e,c){var d=(c%2===0)?"even":"odd",b=(d==="odd")?"even":"odd";if(e.hasClassName(b)){e.removeClassName(b)}if(!e.hasClassName(d)){e.addClassName(d)}})}},selectRow:function(a){this._selectRow(this.table.tBodies[0].rows[a-1])},selectCell:function(b,a){this._selectCell(this.table.tBodies[0].rows[b-1].cells[a-1])},clearSelection:function(){this.table.tBodies[0].select(".selected").invoke("removeClassName","selected")},focus:function(){this.body.focus()},sort:function(e,c){function a(h,f){var j=Object.isArray(h)?b:e,g=(c.toUpperCase()==="ASC")?1:-1,i;h=h[j];f=f[j];if(typeof h=="object"){h=h.value?h.value:h.text}if(typeof f=="object"){f=f.value?f.value:f.text}if(!Object.isString(h)&&!Object.isNumber(h)){h=h[Object.keys(h)[0]];f=f[Object.keys(f)[0]]}if(h===f){return 0}if(d==="num"){i=h-f}else{if(h==f){i=0}else{if(h>f){i=1}else{i=-1}}}return i*g}var b=Object.keys(this._columnsByName).indexOf(e),d=this._columnsByName[e].sortType;if(typeof c==="undefined"){c=this._sortOrder}this.data.sort(a);this.setSort(e,c);this.reload()},setSort:function(c,a){var b=this.header.select("th");index=Object.keys(this._columnsByName).indexOf(c);b.invoke("removeClassName","sorted-asc");b.invoke("removeClassName","sorted-desc");b[index].addClassName("sorted-"+a.toLowerCase());this._sortBy=c;this._sortOrder=a},filter:function(b){var a=[];if(this._backupData===null){this._backupData=this.data.clone()}this._filterParams=b;this.data=[];this._backupData.each(function(e,c){var d=true;Object.keys(b).each(function(i,h){var f=Object.isArray(e)?h:i,g=(typeof e[f]==="object")?e[f].text:String(e[f]);if(g.indexOf(b[i])===-1){d=false;throw $break}});if(d){a.push(e)}});this.data=a;this.reload()},getRowElement:function(a){var c;if(a>this.data.length+1){throw new Error("ProtopackGrid.getRowElement(): Invalid row index")}try{c=this.table.tBodies[0].rows[--a]}catch(b){throw new Error("ProtopackGrid.getRowElement(): Invalid tr element")}return c},insertRow:function(b,a){if(typeof a=="undefined"||a>this.data.length){a=this.data.length}else{a--}this._insertRow(b,a);this.data.splice(a,0,b);this.refresh();return a+1},deleteRow:function(a){var c;if(a>this.data.length){throw new Error("ProtopackGrid.deleteRow(): Invalid row index")}try{c=this.table.tBodies[0].rows[--a]}catch(b){throw new Error("ProtopackGrid.deleteRow(): Invalid tr element")}c.remove();this.data.splice(a,1);this.refresh()},updateRow:function(a,d){var c;if(a>this.data.length){throw new Error("ProtopackGrid.updateRow(): Invalid row index")}try{c=this.table.tBodies[0].rows[--a]}catch(b){throw new Error("ProtopackGrid.updateRow(): Invalid tr element")}c.remove();this._insertRow(d,a);this.data[a]=d;this.refresh()},updateCell:function(f,c,b){var a;if(f>this.data.length){throw new Error("ProtopackGrid.updateCell(): Invalid row index")}try{a=this.table.tBodies[0].rows[--f].cells[c-1]}catch(e){throw new Error("ProtopackGrid.updateCell(): Invalid cell element")}var d=this._createElement(this._columns[c-1],b);a.update(d);this.data[f][c]=b}});Protopack.Select=Class.create(Protopack.Input,{options:{className:"pselect",readonly:false,listSize:8},initialize:function(b,a){this.options=Object.clone(this.options);Object.extend(this.options,a||{});this.className=this.options.className;this.readonly=this.options.readonly;this.buttonStyle="disabled";this.dropdownStyle="auto";if(b){this.target=$(b);this.xhtml=this.construct()}},construct:function($super){var a=$super();this.listBox=this.buildListBox();this.dropdown.setContent(this.listBox);this.render();return a},buildListBox:function(){var a=new Element("select",{size:0});if(a.selectedIndex!==-1){this.entry.value=a.options[a.selectedIndex].text}a.observe("click",this.selectItem.bind(this));return a},selectItem:function(a){if(this.listBox.selectedIndex!==-1){this.entry.value=this.listBox.options[this.listBox.selectedIndex].text}this.dropdown.close()},render:function($super){$super();this.listBox.size=(this.listBox.options.length<this.options.listSize)?this.listBox.options.length:this.options.listSize},setData:function(a){if(Object.isArray(a)){a.each(function(b){this.listBox.options[this.listBox.options.length]=new Option(b[1],b[0])}.bind(this))}else{this.listBox=$(a);this.dropdown.setContent(this.listBox)}this.render()}});